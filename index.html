<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Servo Control</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
    }
    #conn {
      font-size: 1.2rem;
      font-weight: 600;
      padding: .4rem 1rem;
      border-radius: 8px;
    }
    .ok { color: #0a0; }
    .bad { color: #c00; }
    .row {
      display: flex;
      gap: 1rem;
    }
    button {
      padding: .8rem 1.4rem;
      border-radius: 10px;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 1rem;
    }
  </style>
</head>
<body>

  <div id="conn" class="bad">connecting…</div>

  <div class="row">
    <button id="b1" onclick="pulse(1)">Servo 1</button>
    <button id="b2" onclick="pulse(2)">Servo 2</button>
    <button id="b3" onclick="pulse(3)">Servo 3</button>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    // topics
    const BASE = 'nano32/servo/';
    const T1 = BASE + '1';
    const T2 = BASE + '2';
    const T3 = BASE + '3';

    const connEl = document.getElementById('conn');

    // MQTT connect
    const client = mqtt.connect('wss://test.mosquitto.org:8081', {
      clientId: 'web-' + Math.random().toString(16).slice(2),
      protocolVersion: 4,
      keepalive: 30,
      reconnectPeriod: 1500
    });

    client.on('connect', () => {
      connEl.textContent = "connected";
      connEl.classList.remove("bad");
      connEl.classList.add("ok");
    });

    client.on('close', () => {
      connEl.textContent = "disconnected";
      connEl.classList.remove("ok");
      connEl.classList.add("bad");
    });

    client.on('error', () => {
      connEl.textContent = "error";
      connEl.classList.remove("ok");
      connEl.classList.add("bad");
    });

    client.on('reconnect', () => {
      connEl.textContent = "reconnecting…";
      connEl.classList.remove("ok");
      connEl.classList.add("bad");
    });

    function pub(topic, value) {
      client.publish(topic, String(value), { qos: 1, retain: false });
    }

    function lock(btn, ms) {
      btn.disabled = true;
      setTimeout(() => btn.disabled = false, ms);
    }

    function pulse(id) {
      const topic = (id === 1) ? T1 : (id === 2) ? T2 : T3;
      const btn = document.getElementById('b' + id);

      pub(topic, "show");
      lock(btn, 2500);
    }
  </script>
</body>
</html>
